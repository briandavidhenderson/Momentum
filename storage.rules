rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is administrator
    function isAdmin() {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdministrator == true;
    }

    // Project files - only project members can access
    match /projects/{projectId}/{allPaths=**} {
      // Allow read if user is project member
      allow read: if isAuthenticated() && 
        firestore.exists(/databases/(default)/documents/memberships/$(projectId + '_' + request.auth.uid));
      // Allow write if user is admin or project member
      allow write: if isAuthenticated() && 
        (isAdmin() ||
         firestore.exists(/databases/(default)/documents/memberships/$(projectId + '_' + request.auth.uid)));
    }

    // Safety vault - restricted to admins
    match /safety/{allPaths=**} {
      allow read: if isAuthenticated() && isAdmin();
      allow write: if isAuthenticated() && isAdmin();
    }

    // Templates - all authenticated users can read, admins can write
    match /templates/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // User avatars - users can read/write their own
    match /avatars/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // General documents - authenticated users can read, admins can write
    match /documents/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // Research Board files - enforce pin visibility
    // Research Board files - enforce pin visibility
    match /research/{labId}/{pinId}/{allPaths=**} {
      // Read: Check pin visibility in Firestore
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (
          firestore.exists(/databases/(default)/documents/researchPins/$(pinId)) && 
          (
            // Public pins
            firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data.visibility == 'public' ||
            // Author access
            firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data.author.userId == request.auth.uid ||
            // Lab access (explicit 'lab' visibility OR default if not private)
            (
              isLabMember(labId) && 
              (
                firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data.visibility == 'lab' ||
                (
                  !('visibility' in firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data) && 
                  firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data.isPrivate != true
                )
              )
            )
          )
        )
      );

      // Write: Allow lab members or pin authors to upload
      allow write: if isAuthenticated() && (
        isAdmin() ||
        (
          (
            isLabMember(labId) ||
            (firestore.exists(/databases/(default)/documents/researchPins/$(pinId)) &&
             firestore.get(/databases/(default)/documents/researchPins/$(pinId)).data.author.userId == request.auth.uid)
          )
        )
      );
    }

    // Helper: get user's profileId and labId
    function getUserProfileId() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.profileId;
    }

    function getUserLab() {
      let profileId = getUserProfileId();
      return profileId == null ? null : firestore.get(/databases/(default)/documents/personProfiles/$(profileId)).data.labId;
    }

    function isLabMember(labId) {
      return getUserLab() != null && getUserLab() == labId;
    }

    // ELN files - allow lab members to read/write within their lab's folder
    // Path: eln/{labId}/{experimentId}/{itemId}/...
    match /eln/{labId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && (isAdmin() || isLabMember(labId));
    }
  }
}
