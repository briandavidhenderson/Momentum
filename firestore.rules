rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // ============================================================================
    // EVENTS (Calendar)
    // ============================================================================
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.createdBy == request.auth.uid);
    }

    // ============================================================================
    // AUDIT TRAILS
    // ============================================================================
    match /auditTrails/{auditId} {
      // Readable by authenticated users (used in Right Info Panel)
      allow read: if isAuthenticated();
      // Create-only endpoint; no updates or deletes by regular users
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Helper function to check if user is administrator
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdministrator == true;
    }

    // Helper function to get user's profile ID
    function getUserProfileId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.profileId : null;
    }

    // Helper function to get user's profile
    function getUserProfile() {
      let profileId = getUserProfileId();
      return profileId != null ? get(/databases/$(database)/documents/personProfiles/$(profileId)) : null;
    }

    // Helper function to get user's lab ID
    function getUserLab() {
      let userProfile = getUserProfile();
      return userProfile != null && userProfile.data != null ? userProfile.data.labId : null;
    }

    // Helper function to check if user can view a project
    // Projects are scoped to labs - users can only see projects created by users in their lab
    // Note: Projects should have a 'labId' field set when created. If not present, 
    //       the project is visible to all authenticated users (fallback behavior)
    function canViewProject(projectData) {
      return isAuthenticated() && (
        isAdmin() ||
        (projectData.labId != null && projectData.labId == getUserLab()) ||
        projectData.createdBy == request.auth.uid ||
        projectData.labId == null  // Fallback: allow if labId not set (will be filtered client-side)
      );
    }

    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // All authenticated users can read all user profiles (for collaboration)
      allow read: if isAuthenticated();
      
      // Users can update their own profile (limited fields)
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // User creation handled by Auth triggers
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================================================
    // PERSON PROFILES COLLECTION
    // ============================================================================
    match /personProfiles/{profileId} {
      // Users can read profiles (lab filtering done client-side to avoid circular dependency)
      // Note: This allows reading all profiles, but client-side code should filter by lab
      allow read: if isAuthenticated();

      // Users can create their own profile
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own profile, admins can update any
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // ============================================================================
    // ORGANISATIONS (Shared Reference Data)
    // ============================================================================
    match /organisations/{orgId} {
      // All authenticated users can read organisations
      allow read: if isAuthenticated();
      
      // Any authenticated user can create an organisation
      allow create: if isAuthenticated();
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // INSTITUTES (Shared Reference Data)
    // ============================================================================
    match /institutes/{instituteId} {
      // All authenticated users can read institutes
      allow read: if isAuthenticated();
      
      // Any authenticated user can create an institute
      allow create: if isAuthenticated();
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // LABS (Shared Reference Data)
    // ============================================================================
    match /labs/{labId} {
      // All authenticated users can read labs
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a lab
      allow create: if isAuthenticated();
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // FUNDERS (Shared Reference Data)
    // ============================================================================
    match /funders/{funderId} {
      // All authenticated users can read funders
      allow read: if isAuthenticated();

      // Any authenticated user can create a funder
      allow create: if isAuthenticated();

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // FUNDING ACCOUNTS
    // ============================================================================
    // Helper function to check if user is a member of a master project
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/masterProjects/$(projectId));
      return project != null && project.data != null && (
        getUserProfileId() in project.data.teamMemberIds
      );
    }

    // Helper function to check if user is PI of a master project
    function isProjectPI(projectId) {
      let project = get(/databases/$(database)/documents/masterProjects/$(projectId));
      return project != null && project.data != null && (
        getUserProfileId() in project.data.principalInvestigatorIds
      );
    }

    match /accounts/{accountId} {
      // Users can read accounts for projects they're a member of
      // Temporary: Allow all authenticated users to read (set up user roles for stricter access)
      allow read: if isAuthenticated();

      // PIs can create accounts for their projects
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isProjectPI(request.resource.data.masterProjectId)
      );

      // PIs or admins can update accounts
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isProjectPI(resource.data.masterProjectId)
      );

      // Only PIs or admins can delete accounts
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isProjectPI(resource.data.masterProjectId)
      );
    }

    // ============================================================================
    // MASTER PROJECTS
    // ============================================================================
    // Helper function to check if user is member of project's lab
    function isLabMember(labId) {
      let userProfile = getUserProfile();
      return userProfile != null && userProfile.data != null && userProfile.data.labId == labId;
    }

    match /masterProjects/{projectId} {
      // Users can read projects if they are:
      // - A member of the project's lab
      // - A member of the project team
      // - An admin
      allow read: if isAuthenticated() && (
        isAdmin() ||
        isLabMember(resource.data.labId) ||
        getUserProfileId() in resource.data.teamMemberIds
      );

      // PIs and lab members can create projects
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLabMember(request.resource.data.labId)
      );

      // PIs or admins can update projects
      allow update: if isAuthenticated() && (
        isAdmin() ||
        getUserProfileId() in resource.data.principalInvestigatorIds
      );

      // Only PIs or admins can delete projects
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        getUserProfileId() in resource.data.principalInvestigatorIds
      );
    }

    // ============================================================================
    // PROJECTS COLLECTION (LEGACY)
    // ============================================================================
    match /projects/{projectId} {
      // Users can read projects (lab filtering done client-side)
      // Simplified to avoid circular dependency with getUserLab()
      allow read: if isAuthenticated();

      // Any authenticated user can create a project
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // WORKPACKAGES COLLECTION
    // ============================================================================
    match /workpackages/{workpackageId} {
      // Users can read workpackages if they can see the associated project
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a workpackage
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
      
      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // ORDERS COLLECTION
    // ============================================================================
    match /orders/{orderId} {
      // All authenticated users can read orders
      allow read: if isAuthenticated();
      
      // Any authenticated user can create an order
      allow create: if isAuthenticated();
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
      
      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // INVENTORY COLLECTION
    // ============================================================================
    match /inventory/{itemId} {
      // All authenticated users can read inventory
      allow read: if isAuthenticated();
      
      // Any authenticated user can create inventory items
      allow create: if isAuthenticated();
      
      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
      
      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // DAY-TO-DAY TASKS
    // ============================================================================
    match /dayToDayTasks/{taskId} {
      // Users can read tasks in their lab (collaborative task board)
      allow read: if isAuthenticated() && (
        resource.data.labId == getUserLab() ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Users can create tasks in their own lab
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.labId == getUserLab();

      // Users can update tasks in their lab (allows collaborative editing)
      allow update: if isAuthenticated() && (
        resource.data.labId == getUserLab() ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Users can delete their own tasks or lab members can delete tasks in their lab
      allow delete: if isAuthenticated() && (
        resource.data.labId == getUserLab() ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // LAB POLLS
    // ============================================================================
    match /labPolls/{pollId} {
      // Users can read polls (lab filtering done client-side or in query)
      allow read: if isAuthenticated();

      // Users can create polls
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // EQUIPMENT
    // ============================================================================
    match /equipment/{equipmentId} {
      // Users can read equipment (lab filtering done in query)
      allow read: if isAuthenticated();

      // Users can create equipment
      allow create: if isAuthenticated();

      // Users or admin can update
      allow update: if isAuthenticated();

      // Users or admin can delete
      allow delete: if isAuthenticated();
    }

    // ============================================================================
    // ELN EXPERIMENTS
    // ============================================================================
    match /elnExperiments/{experimentId} {
      // Users can read experiments in their lab
      allow read: if isAuthenticated() && (
        resource.data.labId == getUserLab() ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Users can create their own experiments
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid;

      // Users can update their own experiments
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Users can delete their own experiments
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // GDPR COMPLIANCE COLLECTIONS
    // ============================================================================

    // Helper function to get user's role
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null && userDoc.data.userRole != null
        ? userDoc.data.userRole
        : "researcher";  // Default role
    }

    // Helper function to check if user is PI or Finance Admin
    function isPIOrFinanceAdmin() {
      let role = getUserRole();
      return role == "pi" || role == "finance_admin";
    }

    // Helper function to check if user is Finance Admin
    function isFinanceAdmin() {
      let role = getUserRole();
      return role == "finance_admin" || role == "pi";
    }

    // Helper function to check if user is PI of a lab
    function isLabPI(labId) {
      let lab = get(/databases/$(database)/documents/labs/$(labId));
      return lab != null && lab.data != null && (
        getUserProfileId() in lab.data.principalInvestigators
      );
    }

    // USER CONSENTS - GDPR Cookie & Data Processing Consent
    match /userConsents/{consentId} {
      // Users can read their own consent
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create their own consent
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own consent
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Only admin can delete (for compliance audit)
      allow delete: if isAdmin();
    }

    // PRIVACY SETTINGS - User privacy preferences
    match /privacySettings/{settingsId} {
      // Users can read their own privacy settings
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create their own privacy settings
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own privacy settings
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can delete their own privacy settings
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // DATA EXPORT REQUESTS - GDPR Right of Access
    match /dataExportRequests/{requestId} {
      // Users can read their own export requests
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Users can create their own export requests
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // System/Admin can update status
      allow update: if isAdmin();

      // Only admin can delete (for audit trail)
      allow delete: if isAdmin();
    }

    // ACCOUNT DELETION REQUESTS - GDPR Right to Erasure
    match /accountDeletionRequests/{requestId} {
      // Users can read their own deletion requests, admins can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Users can create their own deletion requests
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // System/Admin can update status
      allow update: if isAdmin();

      // Only admin can delete (for audit trail)
      allow delete: if isAdmin();
    }

    // SPECIAL CATEGORY DATA MARKERS - GDPR Article 9
    match /specialCategoryDataMarkers/{markerId} {
      // Users can read markers for their own content
      allow read: if isAuthenticated();

      // Users can create markers for their own content
      allow create: if isAuthenticated() &&
        request.resource.data.acknowledgedBy == request.auth.uid;

      // Users can update their own markers
      allow update: if isAuthenticated() &&
        resource.data.acknowledgedBy == request.auth.uid;

      // Only admin can delete (for audit)
      allow delete: if isAdmin();
    }

    // AI GENERATED CONTENT - EU AI Act Compliance
    match /aiGeneratedContent/{contentId} {
      // Users can read AI content they generated or admins
      allow read: if isAuthenticated() && (
        resource.data.generatedBy == request.auth.uid ||
        isAdmin()
      );

      // System creates AI content records
      allow create: if isAuthenticated();

      // Users can update their feedback on AI content
      allow update: if isAuthenticated() && resource.data.generatedBy == request.auth.uid;

      // Only admin can delete (for audit)
      allow delete: if isAdmin();
    }

    // DATA RETENTION POLICIES - Admin only
    match /dataRetentionPolicies/{policyId} {
      // All authenticated users can read policies
      allow read: if isAuthenticated();

      // Only admin can create policies
      allow create: if isAdmin();

      // Only admin can update policies
      allow update: if isAdmin();

      // Only admin can delete policies
      allow delete: if isAdmin();
    }

    // ============================================================================
    // ENHANCED FUNDING SYSTEM COLLECTIONS
    // ============================================================================

    // FUNDING ALLOCATIONS - Budget allocations to people/projects
    match /fundingAllocations/{allocationId} {
      // Visibility based on role:
      // - PI/Finance Admin: Can see all allocations in their lab
      // - Researcher: Can see only their own personal allocations and project allocations they're on
      // - Assistant: Can see project allocations for projects they're on
      // - External Collaborator: Cannot see funding data
      // Temporary: Allow all authenticated users to read (set up user roles for stricter access)
      allow read: if isAuthenticated();

      // PI or Finance Admin can create allocations
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isPIOrFinanceAdmin() && request.resource.data.labId == getUserLab())
      );

      // PI or Finance Admin can update allocations
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isPIOrFinanceAdmin() && resource.data.labId == getUserLab())
      );

      // Only PI, Finance Admin, or Admin can delete allocations
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        (isPIOrFinanceAdmin() && resource.data.labId == getUserLab())
      );
    }

    // FUNDING TRANSACTIONS - Ledger entries for all funding movements
    match /fundingTransactions/{transactionId} {
      // Visibility based on role:
      // - PI/Finance Admin: Can see all transactions in their lab
      // - Users: Can see transactions for allocations they have access to
      allow read: if isAuthenticated() && (
        isAdmin() ||
        // PI or Finance Admin can see all in their lab
        (isPIOrFinanceAdmin() && resource.data.labId == getUserLab()) ||
        // Users can see transactions for their allocations (checked via allocationId access)
        resource.data.createdBy == request.auth.uid
      );

      // System creates transactions automatically (orders, adjustments, etc.)
      // PI/Finance Admin can create manual adjustments
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isPIOrFinanceAdmin()
      );

      // Only PI/Finance Admin can update transactions (e.g., status changes)
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (isPIOrFinanceAdmin() && resource.data.labId == getUserLab())
      );

      // Only admin can delete transactions (for audit trail)
      allow delete: if isAdmin();
    }

    // ============================================================================
    // COMMENTS
    // ============================================================================
    match /comments/{commentId} {
      // Users can read comments on entities they have access to
      // Note: This is simplified - ideally we'd check access to the parent entity
      allow read: if isAuthenticated();

      // Users can create comments
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == getUserProfileId() &&
        request.resource.data.createdAt is timestamp;

      // Users can update their own comments (for editing)
      allow update: if isAuthenticated() && (
        resource.data.authorId == getUserProfileId() ||
        isAdmin()
      );

      // Users can delete their own comments
      allow delete: if isAuthenticated() && (
        resource.data.authorId == getUserProfileId() ||
        isAdmin()
      );
    }

    // ============================================================================
    // DEFAULT DENY (catch-all)
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
