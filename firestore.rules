// ============================================================================
// AUTO-GENERATED FILE. DO NOT EDIT DIRECTLY.
// Edit files in firestore/rules/ instead.
// ============================================================================

// Source: firestore/rules/00_base.rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }


// Source: firestore/rules/10_helpers.rules
    // Helper function to check if user is administrator
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdministrator == true;
    }

    // Helper function to get user's profile ID
    function getUserProfileId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.profileId : null;
    }

    // Helper function to get user's profile
    function getUserProfile() {
      let profileId = getUserProfileId();
      return profileId != null ? get(/databases/$(database)/documents/personProfiles/$(profileId)) : null;
    }

    // Helper function to get user's lab ID
    function getUserLab() {
      let userProfile = getUserProfile();
      return userProfile != null && userProfile.data != null ? userProfile.data.labId : null;
    }

    // Helper function to check if user is member of a specific lab
    function isLabMember(labId) {
      let userProfile = getUserProfile();
      return userProfile != null && userProfile.data != null && (
        userProfile.data.labId == labId ||
        (userProfile.data.workingLabIds != null && userProfile.data.workingLabIds.hasAny([labId]))
      );
    }

    // Helper function to check if user is PI of a master project
    function isProjectPI(projectId) {
      let project = get(/databases/$(database)/documents/masterProjects/$(projectId));
      return project != null && project.data != null && (
        getUserProfileId() in project.data.principalInvestigatorIds
      );
    }

    function isProjectTeamMember(projectId) {
      let project = get(/databases/$(database)/documents/masterProjects/$(projectId));
      let profileId = getUserProfileId();
      return profileId != null && project != null && project.data != null && (
        (project.data.teamMemberIds != null && profileId in project.data.teamMemberIds) ||
        (project.data.principalInvestigatorIds != null && profileId in project.data.principalInvestigatorIds) ||
        (project.data.coPIIds != null && profileId in project.data.coPIIds)
      );
    }

    // Helper: Check if user is equipment manager
    function isEquipmentManager(equipmentId) {
      let equipment = get(/databases/$(database)/documents/equipment/$(equipmentId));
      let profileId = getUserProfileId();
      return equipment != null && equipment.data != null && (
        (equipment.data.managerId != null && equipment.data.managerId == profileId) ||
        (equipment.data.managerIds != null && profileId in equipment.data.managerIds)
      );
    }


// Source: firestore/rules/20_users.rules
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // All authenticated users can read all user profiles (for collaboration)
      allow read: if isAuthenticated();

      // Users can update their own profile (limited fields)
      allow update: if isAuthenticated() &&
        request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'isAdministrator',
          'userRole',
          'labId'
        ]);
      
      // User creation handled by Auth triggers
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================================================
    // PERSON PROFILES COLLECTION
    // ============================================================================
    match /personProfiles/{profileId} {
      // Users can read profiles (lab filtering done client-side to avoid circular dependency)
      // Note: This allows reading all profiles, but client-side code should filter by lab
      allow read: if isAuthenticated();

      // Users can create their own profile
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own profile, admins can update any
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // ============================================================================
    // CONSENT (Privacy & Data Protection)
    // ============================================================================
    match /consent/{consentId} {
      // All authenticated users can read consent records
      // (Client-side filters by userId; allows checking if consent exists before creation)
      allow read: if isAuthenticated();

      // Users can create their own consent records
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own consent records
      allow update: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can delete their own consent records
      allow delete: if isAuthenticated() && request.data.userId == request.auth.uid;
    }

    // ============================================================================
    // USER CONSENTS (Cookie Banner & GDPR Compliance)
    // ============================================================================
    match /userConsents/{userId} {
      // Users can read their own consent records
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Users can create their own consent records
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.userId == request.auth.uid;

      // Users can update their own consent records (for consent version updates)
      allow update: if isAuthenticated() && request.auth.uid == userId && resource.data.userId == request.auth.uid;

      // No deletion allowed (GDPR audit trail)
      allow delete: if false;
    }

    // ============================================================================
    // PRIVACY SETTINGS (GDPR User Rights Management)
    // ============================================================================
    match /privacySettings/{userId} {
      // Users can read their own privacy settings
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Users can create their own privacy settings
      allow create: if isAuthenticated() && request.auth.uid == userId && request.resource.data.userId == request.auth.uid;

      // Users can update their own privacy settings
      allow update: if isAuthenticated() && request.auth.uid == userId && resource.data.userId == request.auth.uid;

      // No deletion allowed (GDPR audit trail)
      allow delete: if false;
    }

    // ============================================================================
    // DATA EXPORT REQUESTS (GDPR Article 15 & 20)
    // ============================================================================
    match /dataExportRequests/{requestId} {
      // Users can read their own export requests
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create export requests for themselves
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Admin can update request status (processed by Cloud Function)
      allow update: if isAdmin();

      // No deletion allowed (audit trail)
      allow delete: if false;
    }

    // ============================================================================
    // SPECIAL CATEGORY DATA MARKERS (GDPR Article 9 - Sensitive Data)
    // ============================================================================
    match /specialCategoryDataMarkers/{markerId} {
      // Users can read markers they acknowledged
      allow read: if isAuthenticated() && resource.data.acknowledgedBy == request.auth.uid;

      // Users can create acknowledgment markers
      allow create: if isAuthenticated() && request.resource.data.acknowledgedBy == request.auth.uid;

      // No updates or deletes (immutable audit trail)
      allow update, delete: if false;
    }


// Source: firestore/rules/30_structure.rules
    // ============================================================================
    // ORGANISATIONS (Shared Reference Data)
    // ============================================================================
    match /organisations/{orgId} {
      // All authenticated users can read organisations
      allow read: if isAuthenticated();

      // Authenticated users can create organisations (for onboarding)
      allow create: if isAuthenticated();

      // Allow updates for:
      // - Creator or admin for all fields
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // INSTITUTES (Shared Reference Data)
    // NOTE: "Institutes" now represents Schools/Faculties in the UI
    // ============================================================================
    match /institutes/{instituteId} {
      // All authenticated users can read institutes
      allow read: if isAuthenticated();

      // Any authenticated user can create an institute
      allow create: if isAuthenticated();

      // Allow updates for:
      // - Creator or admin
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // LABS (Shared Reference Data)
    // NOTE: "Labs" now represents Departments in the UI
    // ============================================================================
    match /labs/{labId} {
      // All authenticated users can read labs
      allow read: if isAuthenticated();

      // Authenticated users can create labs (for onboarding)
      // They will become the PI of the lab they create
      allow create: if isAuthenticated();

      // Authenticated users can update labs if they created it or are admin
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // RESEARCH GROUPS (Dynamic Membership)
    // ============================================================================
    match /researchGroups/{groupId} {
      // All authenticated users can read research groups
      allow read: if isAuthenticated();

      // Authenticated users can create research groups
      allow create: if isAuthenticated();

      // Group PIs, coordinators, creator, or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin() ||
        // Check if user is a PI or coordinator of this group
        (getUserProfileId() != null && (
          getUserProfileId() in resource.data.principalInvestigators ||
          getUserProfileId() in resource.data.coordinatorIds
        ))
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // WORKING LABS (Dynamic Membership)
    // ============================================================================
    match /workingLabs/{workingLabId} {
      // All authenticated users can read working labs
      allow read: if isAuthenticated();

      // Authenticated users can create working labs
      allow create: if isAuthenticated();

      // Lab managers, creator, or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin() ||
        // Check if user is a lab manager
        (getUserProfileId() != null &&
         getUserProfileId() in resource.data.labManagerIds)
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }


// Source: firestore/rules/40_projects.rules
    // ============================================================================
    // MASTER PROJECTS
    // ============================================================================
    match /masterProjects/{projectId} {
      // Read: Team members + admins + lab members (backward compatibility)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        getUserProfileId() in resource.data.principalInvestigatorIds ||
        getUserProfileId() in resource.data.coPIIds ||
        getUserProfileId() in resource.data.teamMemberIds ||
        isLabMember(resource.data.labId)
      );

      // Create: Lab members can create projects
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isLabMember(request.resource.data.labId)
      );

      // Update: PIs or admins only
      allow update: if isAuthenticated() && (
        isAdmin() ||
        getUserProfileId() in resource.data.principalInvestigatorIds
      );

      // Delete: PIs or admins only
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        getUserProfileId() in resource.data.principalInvestigatorIds
      );
    }

    // ============================================================================
    // PROJECTS COLLECTION (LEGACY)
    // ============================================================================
    match /projects/{projectId} {
      // Users can only read projects they created OR projects in their lab
      // This ensures proper data privacy - client-side filtering is NOT a security boundary
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Any authenticated user can create a project
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // WORKPACKAGES COLLECTION
    // ============================================================================
    match /workpackages/{workpackageId} {
      // Users can only read workpackages they created OR in their lab
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin() ||
        (resource.data.profileProjectId != null && isProjectTeamMember(resource.data.profileProjectId))
      );

      // Users can create workpackages
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // DELIVERABLES COLLECTION
    // ============================================================================
    // Deliverables are concrete outcomes within workpackages.
    // They are the primary unit of work output in the project hierarchy:
    // Project → Workpackage → Deliverable → (optional) ProjectTask
    match /deliverables/{deliverableId} {
      // Users can only read deliverables they created, own, or in their lab
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        ('ownerId' in resource.data && resource.data.ownerId == getUserProfileId()) ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create deliverables
      // The deliverable must belong to a workpackage (workpackageId is required)
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       'workpackageId' in request.resource.data;

      // Creator, deliverable owner, or admin can update
      // This allows both the creator and the assigned owner to update progress
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        ('ownerId' in resource.data && resource.data.ownerId == getUserProfileId())
      );

      // Creator or admin can delete
      // Note: Deleting a deliverable should also clean up linked ProjectTasks
      // (Consider implementing cascade deletion via Cloud Functions)
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // PROJECT FILES (Storage metadata)
    // ============================================================================
    match /projectFiles/{fileId} {
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.projectId != null && isProjectTeamMember(resource.data.projectId)) ||
        (resource.data.labId != null && isLabMember(resource.data.labId))
      );

      allow create: if isAuthenticated() && (
        isAdmin() ||
        (request.resource.data.projectId != null && isProjectTeamMember(request.resource.data.projectId)) ||
        (request.resource.data.labId != null && isLabMember(request.resource.data.labId))
      );

      allow update, delete: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.projectId != null && isProjectTeamMember(resource.data.projectId)) ||
        (resource.data.labId != null && isLabMember(resource.data.labId))
      );
    }


// Source: firestore/rules/50_resources.rules
    // ============================================================================
    // ORDERS COLLECTION
    // ============================================================================
    match /orders/{orderId} {
      // Users can read orders in their lab. During onboarding (no lab yet), allow
      // users to read records they created so they can complete setup without
      // exposing the entire collection.
      allow read: if isAuthenticated() && (
        (getUserLab() != null && resource.data.labId == getUserLab()) ||
        (getUserLab() == null && resource.data.createdBy == request.auth.uid)
      );

      // Users can create orders
      allow create: if isAuthenticated();

      // Users can update orders if they are in the same lab or created it
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId)
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // INVENTORY COLLECTION
    // ============================================================================
    match /inventory/{itemId} {
      // Users can read inventory in their lab. During onboarding (no lab yet),
      // allow users to read records they created so they can complete setup
      // without exposing the entire collection.
      allow read: if isAuthenticated() && (
        (getUserLab() != null && resource.data.labId == getUserLab()) ||
        (getUserLab() == null && resource.data.createdBy == request.auth.uid)
      );

      // Users can create inventory items
      allow create: if isAuthenticated();

      // Creator, admin, or lab member can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId)
      );

      // Creator, admin, or lab member can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId)
      );
    }

    // ============================================================================
    // EQUIPMENT
    // ============================================================================
    match /equipment/{equipmentId} {
      // Users can only read equipment in their lab
      allow read: if isAuthenticated() && (
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create equipment
      allow create: if isAuthenticated();

      // Users or admin can update
      allow update: if isAuthenticated();

      // Users or admin can delete
      allow delete: if isAuthenticated();
    }

    // ============================================================================
    // EQUIPMENT BOOKINGS
    // ============================================================================
    match /equipmentBookings/{bookingId} {
      // Helper: Check if user is equipment manager
      function isEquipmentManager(equipmentId) {
        let equipment = get(/databases/$(database)/documents/equipment/$(equipmentId));
        let profileId = getUserProfileId();
        return equipment != null && equipment.data != null && (
          (equipment.data.managerId != null && equipment.data.managerId == profileId) ||
          (equipment.data.managerIds != null && profileId in equipment.data.managerIds)
        );
      }

      // Users can read bookings if they are authenticated (needed for cross-lab availability)
      allow read: if isAuthenticated();

      // Users can create bookings if they are authenticated
      // Must be for themselves
      allow create: if isAuthenticated() && (
        request.resource.data.bookedBy == getUserProfileId() &&
        request.resource.data.createdBy == request.auth.uid
      );

      // Users can update their own bookings
      // Admins and equipment managers can update any
      allow update: if isAuthenticated() && (
        resource.data.bookedBy == getUserProfileId() ||
        isAdmin() ||
        isEquipmentManager(resource.data.equipmentId)
      );

      // Only booking owner, admin, or equipment manager can delete
      allow delete: if isAuthenticated() && (
        resource.data.bookedBy == getUserProfileId() ||
        isAdmin() ||
        isEquipmentManager(resource.data.equipmentId)
      );
    }

    // ============================================================================
    // FUNDERS (Shared Reference Data)
    // ============================================================================
    match /funders/{funderId} {
      // All authenticated users can read funders
      allow read: if isAuthenticated();

      // Any authenticated user can create a funder
      allow create: if isAuthenticated();

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // ============================================================================
    // FUNDING ACCOUNTS
    // ============================================================================
    match /accounts/{accountId} {
      // Users can read accounts for projects they're a member of
      // Temporary: Allow all authenticated users to read (set up user roles for stricter access)
      allow read: if isAuthenticated();

      // PIs can create accounts for their projects
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isProjectPI(request.resource.data.masterProjectId)
      );

      // PIs or admins can update accounts
      allow update: if isAuthenticated();

      // Only PIs or admins can delete accounts
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isProjectPI(resource.data.masterProjectId)
      );
    }

    // ============================================================================
    // FUNDING ALLOCATIONS
    // ============================================================================
    match /fundingAllocations/{allocationId} {
      // All authenticated users can read funding allocations
      // (Matches the pattern used for accounts to avoid permission errors during profile setup)
      allow read: if isAuthenticated();

      // Users can create allocations for projects they're PI of or admins
      allow create: if isAuthenticated();

      // PIs or admins can update allocations
      allow update: if isAuthenticated() && (
        isAdmin() ||
        ('masterProjectId' in resource.data && isProjectPI(resource.data.masterProjectId))
      );

      // PIs or admins can delete allocations
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        ('masterProjectId' in resource.data && isProjectPI(resource.data.masterProjectId))
      );
    }

    // ============================================================================
    // BUFFERS (Lab-wide buffer recipes)
    // ============================================================================
    match /buffers/{bufferId} {
      // Users can read buffers in their lab
      allow read: if isAuthenticated() && (
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create buffers in their lab
      allow create: if isAuthenticated() && (
        request.resource.data.createdBy == request.auth.uid &&
        isLabMember(request.resource.data.labId)
      );

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }


// Source: firestore/rules/60_safety.rules
    // ============================================================================
    // RISK ASSESSMENTS (Safety - Phase 3)
    // ============================================================================
    match /riskAssessments/{assessmentId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
    }

    // ============================================================================
    // INCIDENTS (Safety - Phase 3)
    // ============================================================================
    match /incidents/{incidentId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.reportedBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
    }

    // ============================================================================
    // TRAINING RECORDS (Safety - Phase 3)
    // ============================================================================
    match /trainingRecords/{recordId} {
      // Users can read their own training records
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Admins or trainers can create/update records
      // For now, allow creation if authenticated (to allow seeding/testing), 
      // but ideally this should be restricted to authorized trainers
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.userId == request.auth.uid // Allow users to update their own records (e.g. status)
      );
      
      allow delete: if isAdmin();
    }


// Source: firestore/rules/70_collaboration.rules
    // ============================================================================
    // EVENTS (Calendar)
    // ============================================================================
    match /events/{eventId} {
      // Users can read events they created OR events with lab/org visibility in their lab
      // Private events are only visible to creator
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        (resource.data.visibility == 'lab' && 'labId' in resource.data && isLabMember(resource.data.labId)) ||
        (resource.data.visibility == 'organisation')
      );
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Users can update events they created OR events in same lab (if admin)
      // External events (read-only) cannot be updated unless isReadOnly is removed
      allow update: if isAuthenticated() && (
        (resource.data.createdBy == request.auth.uid &&
         (!('isReadOnly' in resource.data) || resource.data.isReadOnly != true)) ||
        isAdmin()
      );

      // External read-only events cannot be deleted
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.createdBy == request.auth.uid &&
         (!('isReadOnly' in resource.data) || resource.data.isReadOnly != true))
      );
    }

    // ============================================================================
    // CALENDAR EVENTS (Synced from external calendars)
    // ============================================================================
    match /calendarEvents/{eventId} {
      // Users can read events synced to their profile
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.profileId == getUserProfileId()
      );

      // Only Cloud Functions can create/update calendar events (via sync)
      // Users cannot directly create external calendar events
      allow create, update: if false;

      // Users can delete synced events to remove them from their view
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.profileId == getUserProfileId()
      );
    }

    // ============================================================================
    // CALENDAR CONNECTIONS (NEW)
    // ============================================================================
    match /calendarConnections/{connectionId} {
      // Users can only access their own connections
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can create their own connections
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own connections
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can delete their own connections
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // CALENDAR SYNC LOGS (NEW)
    // ============================================================================
    match /calendarSyncLogs/{logId} {
      // Users can read their own logs
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Only Cloud Functions can create logs
      allow create: if false;

      // No updates or deletes allowed
      allow update, delete: if false;
    }

    // ============================================================================
    // CALENDAR CONFLICTS (NEW)
    // ============================================================================
    match /calendarConflicts/{conflictId} {
      // Users can read their own conflicts
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can resolve (update) their own conflicts
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Only Cloud Functions can create conflicts
      allow create: if false;

      // No deletes allowed
      allow delete: if false;
    }

    // ============================================================================
    // CALENDAR TOKENS (NEW - INTERNAL ONLY)
    // ============================================================================
    // This collection stores OAuth tokens and should NEVER be accessible from clients
    // Only Cloud Functions can read/write to this collection
    match /_calendarTokens/{tokenId} {
      // No client access - all operations blocked
      allow read, write: if false;
    }

    // ============================================================================
    // DAY-TO-DAY TASKS
    // ============================================================================
    // ============================================================================
    // DAY-TO-DAY TASKS
    // ============================================================================
    match /dayToDayTasks/{taskId} {
      // Users can only read tasks they created OR in their lab
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create tasks
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Users can update tasks if they created it, are in the lab, or are assigned
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin() ||
        (resource.data.assigneeIds != null && request.auth.uid in resource.data.assigneeIds)
      );

      // Users can delete tasks they created or admins can delete any
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // PROTOCOLS (Phase 2)
    // ============================================================================
    match /protocols/{protocolId} {
      // Users can read protocols in their lab
      allow read: if isAuthenticated() && (
        resource.data.labId == getUserLab() || 
        resource.data.isPublic == true ||
        isAdmin()
      );

      // Users can create protocols
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // PROTOCOL EXECUTIONS
    // ============================================================================
    match /protocolExecutions/{executionId} {
      // Users can read executions in their lab or if they performed it
      allow read: if isAuthenticated() && (
        resource.data.performedBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create executions
      allow create: if isAuthenticated() && request.resource.data.performedBy == request.auth.uid;

      // Users can update executions they performed or if they are admin
      allow update: if isAuthenticated() && (
        resource.data.performedBy == request.auth.uid ||
        isAdmin()
      );

      // Users can delete executions they performed or if they are admin
      allow delete: if isAuthenticated() && (
        resource.data.performedBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // LAB POLLS
    // ============================================================================
    match /labPolls/{pollId} {
      // Users can only read polls they created OR in their lab
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create polls
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // ELN EXPERIMENTS
    // ============================================================================
    match /elnExperiments/{experimentId} {
      // Users can read experiments they created, in their lab, or linked to their projects
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin() ||
        (resource.data.masterProjectId != null && isProjectTeamMember(resource.data.masterProjectId)) ||
        (resource.data.sharedWithUsers != null && resource.data.sharedWithUsers.hasAny([request.auth.uid]))
      );

      // Users can create their own experiments
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Users can update their own experiments
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );

      // Users can delete their own experiments
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // ANNOUNCEMENTS (Lab Communication - Phase 5)
    // ============================================================================
    match /announcements/{announcementId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.publishedBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.publishedBy == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.publishedBy == request.auth.uid || isAdmin());
    }

    // ============================================================================
    // PROTOCOL TEMPLATES (Shared Templates - Phase 5)
    // ============================================================================
    match /protocolTemplates/{templateId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.createdBy == request.auth.uid || isAdmin());
    }

    // ============================================================================
    // WHITEBOARDS
    // ============================================================================
    match /whiteboards/{whiteboardId} {
      // Users can only read whiteboards they created OR in their lab
      allow read: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isLabMember(resource.data.labId) ||
        isAdmin()
      );

      // Users can create whiteboards
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;

      // Creator or admin can update
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );

      // Creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // RESEARCH BOARDS
    // ============================================================================
    match /researchBoards/{boardId} {
      // Users can read boards if they are:
      // - A member of the board (explicit membership)
      // - A member of the lab (backward compatibility during migration)
      // - An admin
      allow read: if isAuthenticated() && (
        isAdmin() ||
        resource.data.creatorId == request.auth.uid ||
        (resource.data.members != null && resource.data.members.hasAny([request.auth.uid])) ||
        (resource.data.sharedWithUsers != null && resource.data.sharedWithUsers.hasAny([request.auth.uid])) ||
        isLabMember(resource.data.labId)
      );

      // Users can create boards (must be in their lab)
      allow create: if isAuthenticated() && (
        request.resource.data.creatorId == request.auth.uid &&
        isLabMember(request.resource.data.labId)
      );

      // Members or lab members can update boards
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.members != null && resource.data.members.hasAny([request.auth.uid])) ||
        isLabMember(resource.data.labId)
      );

      // Only creator or admin can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.creatorId == request.auth.uid
      );

      // ============================================================================
      // BOARD MESSAGES (Subcollection)
      // ============================================================================
      match /messages/{messageId} {
        // Helper to check board access
        function canAccessBoard() {
          let board = get(/databases/$(database)/documents/researchBoards/$(boardId));
          return board != null && (
            isAdmin() ||
            (board.data.members != null && board.data.members.hasAny([request.auth.uid])) ||
            isLabMember(board.data.labId)
          );
        }

        // Messages inherit board-level security
        allow read: if isAuthenticated() && canAccessBoard();

        // Users can create messages if they can access the board
        allow create: if isAuthenticated() &&
          request.resource.data.boardId == boardId &&
          canAccessBoard();
      }
    }

    // ============================================================================
    // RESEARCH PINS (Research Board)
    // ============================================================================
    match /researchPins/{pinId} {
      // Users can read pins they created OR public/lab pins in their lab
      // Private pins are only visible to creator
      allow read: if isAuthenticated() && (
        resource.data.author.userId == request.auth.uid ||
        (resource.data.visibility == 'public') ||
        (resource.data.visibility == 'lab' && 'labId' in resource.data && isLabMember(resource.data.labId)) ||
        (!('visibility' in resource.data) && resource.data.isPrivate != true && 'labId' in resource.data && isLabMember(resource.data.labId)) ||
        isAdmin()
      );

      // Create: Authenticated users (must be the author)
      allow create: if isAuthenticated() && 
        request.resource.data.author.userId == request.auth.uid;

      // Update: Creator or admin
      allow update: if isAuthenticated() && (
        resource.data.author.userId == request.auth.uid ||
        isAdmin()
      );

      // Delete: Creator or admin
      allow delete: if isAuthenticated() && (
        resource.data.author.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // ============================================================================
    // COMMENTS (Threaded discussions on entities)
    // ============================================================================
    match /comments/{commentId} {
      // Allow authenticated users to read non-deleted comments
      allow read: if isAuthenticated() && resource.data.isDeleted != true;

      // Create: authenticated user creating as their own profile
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == getUserProfileId();

      // Update: author (profile) or admin; authorId cannot change
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.authorId == getUserProfileId() &&
         request.resource.data.authorId == resource.data.authorId)
      );

      // Delete: author or admin (soft delete in client)
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.authorId == getUserProfileId()
      );
    }


// Source: firestore/rules/80_misc.rules
    // ============================================================================
    // NOTIFICATIONS
    // ============================================================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // System and authenticated users can create notifications
      allow create: if isAuthenticated();

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================================================
    // AI GENERATED CONTENT (GDPR/EU AI Act Compliance)
    // ============================================================================
    match /aiGeneratedContent/{contentId} {
      // Users can read AI content records they created
      allow read: if isAuthenticated() && resource.data.generatedBy == request.auth.uid;

      // Users can create AI content records
      allow create: if isAuthenticated() && request.resource.data.generatedBy == request.auth.uid;

      // No updates or deletes (audit trail for compliance)
      allow update, delete: if false;
    }

    // ============================================================================
    // SAMPLES (Sample Genealogy - Phase 4)
    // ============================================================================
    match /samples/{sampleId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
    }

    // ============================================================================
    // STORAGE LOCATIONS (Sample Management - Phase 6)
    // ============================================================================
    match /storageLocations/{locationId} {
      allow read: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
      allow delete: if isAuthenticated() && (resource.data.labId == getUserLab() || isAdmin());
    }

    // ============================================================================
    // ORCID RECORDS
    // ============================================================================
    match /orcidRecords/{orcidId} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();

      // Allow create/update if authenticated
      // Ideally we should check if the user claims this ORCID, but for now allow authenticated writes
      allow write: if isAuthenticated();
    }

    // ============================================================================
    // AUDIT TRAILS
    // ============================================================================
    match /auditTrails/{auditId} {
      // Readable by authenticated users (used in Right Info Panel)
      allow read: if isAuthenticated();
      // Create-only endpoint; no updates or deletes by regular users
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }


// Source: firestore/rules/99_footer.rules
    // ============================================================================
    // DEFAULT DENY (catch-all)
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


